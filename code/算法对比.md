## 光流法

#### 原理

光流的概念是指在连续的两帧图像中由于图像中的物体移动或者摄像头的移动导致的图像中目标像素的移动，利用图像序列中像素在时间域上的变化以及相邻帧之间的相关性来找到上一帧跟当前帧之间存在的对应关系，从而计算出相邻帧之间物体的运动信息。光流场是一个二维矢量场，它反映了图像上每一点灰度的变化趋势，可看成是带有灰度的像素点在图像平面上运动而产生的瞬时速度场。

所有光流法都基于以下的两个假设：
1. **亮度恒定不变** 。即同一目标（像素）在不同帧间运动时，其亮度不会发生变化。这是光流法的基本假定（所有的光流法都必须满足这一假设）。
2. **时间连续或者运动是“小运动”**。即目标的位置不会发生剧烈的变化，相邻两帧间对应像素的位移较小。

光流法的基本约束方程：
基于假设1，认为一个像素点运动前后的光强时不变的，即：
$$
I(x,y,t)=I(x+dx,y+dy,t+dt)\tag{1}
$$
将式(1)右侧进行泰勒展开，得：
$$
I(x,y,t)=I(x,y,t)+\frac{\partial I}{\partial x}dx +\frac{\partial I}{\partial y}dy+\frac{\partial I}{\partial t}dt+\varepsilon \tag{2}
$$
其中$$\varepsilon$$为二阶无穷小项，可忽略不计，可得：
$$
\frac{\partial I}{\partial x}\frac{dx}{dt}+\frac{\partial I}{\partial y}\frac{dy}{dt}+\frac{\partial I}{\partial t}=0 \tag{3}
$$
将式(3)简写为：
$$
I_xu+I_yv+I_t=0\tag{4}
$$
其中$$I_x,I_y,I_t$$均可由图像数据求出，而$$(u,v)$$即为所求的光流矢量。

未知量有两个，约束方程只有一个，因此还需要引入一个约束方程。

---

##### 传统LK光流法

加入假设3：**空间一致性**，即相邻的像素点也有相似的运动。

基于这个假设，还能再加入一个约束方程，假设在一个$$m \times m(n=m^2)$$大小的窗口内，图像的光流是一个恒定值，那么就可以得到：
$$
I_{x1}u+I_{y1}v=-I_{t1}
\\
I_{x2}u+I_{y2}v=-I_{t2}
\\
\vdots
\\
I_{xn}u+I_{yn}v=-I_{tn}
$$
写作矩阵得：
$$
\begin{bmatrix}
I_{x1} & I_{y1} \\
I_{x2} & I_{y2} \\
\vdots & \vdots \\
I_{xn} & I_{yn}
\end{bmatrix}

\begin{bmatrix}
u \\
v
\end{bmatrix}
=
\begin{bmatrix}
-I_{t1} \\
-I_{t2} \\
\vdots \\
-I_{tn}
\end{bmatrix}
\Rightarrow
A\vec{V}=-b
$$
可以用最小二乘法解此方程得：
$$
\vec{V}=(A^TA)^{-1}A^T(-b)
$$
其中求得的$$\vec{V}$$就是LK算法对应的光流矢量，其中要求$$A^TA$$可逆，因此LK算法通常是选取一些$$A^TA$$可逆的点，也就是一些亮度变化比较明显的点，故在实际应用中，通常LK光流法配合角点检测算法使用。例如OpenCV提供的LK光流法函数需要提取图像中的角点，然后使用LK算法对这些角点进行跟踪。

LK算法的优点：因为是通过结合多个临近像素的信息求解光流方程，因此可以**有效地消除光流方程的多义性**，且**对图像噪声不敏感**

LK算法的缺点：**属于稀疏光流法，精度较低**

**LK光流法属于稀疏光流法，稀疏光流法只跟踪指定的一组点，这些点最好具有某种明显的特性，因此稀疏光流法通常需要搭配特征点提取算法（如Harris角点提取等）**

---

##### LK算法改进（金字塔LK光流法）

LK算法基于以下假设：亮度不变、区域一致性以及小速度，这些都是较强的假设，实际应用中很难同时满足三个条件，金字塔法主要是为了解决小速度这个约束。考虑到**物体的运动速度较大**的时候，LK算法会出现较大的误差，金字塔法就是通过**缩小图像的尺寸**来减少图像中像素的运动速度。假设当图像为400×400时，物体速度为[16 16],那么图像缩小为200×200时，速度变为[8,8]。缩小为100×100时，速度减少到[4,4]。所以可以通过生成原图像的金字塔图像，进行逐层求解，最终可以得到较为精确的解。

金字塔法**解决了LK算法要求速度较小的问题**，但是计算复杂度高，时效性较差。

---

##### 稠密光流

稀疏光流法只跟踪特定的点，而稠密光流法则是针对某一区域或者整幅图像进行逐点图像配准的方法，会**计算所有点的位移**，从而形成稠密的光流场。

稠密光流法的优点：效果与精度由于稀疏光流法，且因为不进行特征提取，所以针对**特征不明显、纹理不明显**的物体，稠密光流法的效果更好。

稠密光流法的缺点：由于要对所有的点进行计算，所以**计算量较大，时效性较差**。

---

#### 光流法总结

光流法可以识别检测运动物体的位置，并且还能检测出运动物体的运动信息，但是光流法的使用条件，即几个基本的**假设在实际应用场景下很难满足**：

1. **亮度恒定不变**
2. **小运动**

且对于光流法，时效性和精确性很难兼得。选择稠密光流就要损失速度，选择稀疏光流就会损失精度 。



## 帧差法

帧差法主要的原理为：在图像序列相邻两帧或三帧间采用基于像素的时间差分通过闭值化来提取出图像中的运动区域。

帧差法分为：二帧差法以及三帧差法，二帧差法直接对相邻的两帧图像进行差分

二帧差法步骤如下：

1. **将相邻两帧的图像转化为灰度图**
2. **将前后两帧的灰度图相减得到差分图像**
3. **将差分图像根据阈值进行二值化，进行分割**
4. **对二值化后的图像进行形态学变换（如腐蚀膨胀等操作）以及滤波**
5. **对分割后的区域进行检测，去除面积较小的区域，最终得到检测结果**

三帧差法则是在二帧差法的基础上改进而来

二帧差法的步骤如下：

1. **将相邻的三帧图像转化为灰度图**
2. **将前两帧的灰度图相减得到差分图像1**
3. **将后两帧的灰度图相减得到差分图像2**
4. **将差分图像1和2按像素做”与“操作**
5. **根据阈值进行二值化**
6. **进行形态学变换以及滤波**
7. **得到运动检测结果**

帧差法的优点：算法实现简单，计算量小，实时性好，对于光线的适应性好，鲁棒性较强

帧差法的缺点：只能提取出运动物体的边界，对象内部会有空洞；对于快速运动的物体，容易出现鬼影，有时甚至可能会检测成两个运动物体；对于运动缓慢的物体，前后两帧几乎重叠时，帧差法容易检测不到物体。且对于噪声较为敏感，在阈值选择时需要十分小心，过低的阈值会导致不足以抑制图像中的噪声，过高的阈值会导致忽略了图像中某些物体的运动

故帧差法只适用于简单的实时运动检测场景。

---

### 特征点检测

1. Harris角点检测

   优点：具有不变性，可以抵抗光照、旋转、平移、尺度等变化

   缺点：不具备尺度不变性，当图像放大或者缩小的时候可能导致原有角点检测不出的情况

2. SIFT特征提取

   优点：对旋转、尺度缩放、亮度变化具有不变性；对于视角变换、仿射变换以及噪声也能保持一定的稳定；由于描述子为128维，故信息丰富，鉴别性强

   缺点：由于需要大量的下采样以及插值，所以实时性较差；且对于边缘光滑的目标无法准确地提取特征点

3. SURF特征提取

   优点：SURF对于SIFT算法的特征检测和描述子进行了改进，使得SURF的鲁棒性较好，且改善了其实时性

   缺点：SURF虽然对SIFT算法的速度进行了改进，但是没有实现质的飞跃，直至ORB算法的出现；且由于SURF简化了特征描述子，故精度有所下降

4. FAST特征提取

   优点：快速性，实时性好；稳定性，对于光照、噪声、图像旋转等因素都有较好的鲁棒性

   缺点：不具备尺度不变性，对图像的噪声比较敏感，精度相比SIFT和SURF较低

5. ORB特征提取

   优点：ORB算法结合了FAST算法的特征点检测过程和BRIEF描述子，因此速度很快；具备旋转不变性

   缺点：没有解决FAST不具备尺度不变性的问题



